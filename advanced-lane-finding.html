<!DOCTYPE html>
<html lang="en">
<head>
        <meta charset="utf-8" />
        <title>Advanced Lane Finding</title>
        <link rel="stylesheet" href="/theme/css/main.css" />
        <link href="/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="A Pelican Blog Atom Feed" />

        <!--[if IE]>
            <script src="https://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="/">A Pelican Blog </a></h1>
                <nav><ul>
                    <li><a href="/category/ab-testing.html">AB Testing</a></li>
                    <li><a href="/category/data-analysis.html">Data Analysis</a></li>
                    <li><a href="/category/finance.html">Finance</a></li>
                    <li><a href="/category/machine-learning.html">Machine Learning</a></li>
                    <li><a href="/category/recommendation-system.html">Recommendation System</a></li>
                    <li class="active"><a href="/category/self-driving-car.html">Self Driving Car</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="/advanced-lane-finding.html" rel="bookmark"
           title="Permalink to Advanced Lane Finding">Advanced Lane Finding</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2017-02-05T00:00:00+00:00">
                Published: Sun 05 February 2017
        </abbr>

<p>In <a href="/category/self-driving-car.html">Self Driving Car</a>.</p>

</footer><!-- /.post-info -->      <h1>Advanced Lane Finding</h1>
<p>The goals / steps of this project are the following:</p>
<ul>
<li>Compute the camera calibration matrix and distortion coefficients given a set of chessboard images.</li>
<li>Apply a distortion correction to raw images.</li>
<li>Use color transforms, gradients, etc., to create a thresholded binary image.</li>
<li>Apply a perspective transform to rectify binary image ("birds-eye view").</li>
<li>Detect lane pixels and fit to find the lane boundary.</li>
<li>Determine the curvature of the lane and vehicle position with respect to center.</li>
<li>Warp the detected lane boundaries back onto the original image.</li>
<li>Output visual display of the lane boundaries and numerical estimation of lane curvature and vehicle position.</li>
</ul>
<h4>Description of how I computed the camera matrix and distortion coefficients.</h4>
<p>I started by preparing "object points", which will be the (x, y, z) coordinates of the chessboard corners in the world. Here I am assuming the chessboard is fixed on the (x, y) plane at z=0, such that the object points are the same for each calibration image.  Thus, <code>objp</code> is just a replicated array of coordinates, and <code>objpoints</code> will be appended with a copy of it every time I successfully detect all chessboard corners in a test image.  <code>imgpoints</code> will be appended with the (x, y) pixel position of each of the corners in the image plane with each successful chessboard detection.  </p>
<p>I then used the output <code>objpoints</code> and <code>imgpoints</code> to compute the camera calibration and distortion coefficients using the <code>cv2.calibrateCamera()</code> function.  I applied this distortion correction to the test image using the <code>cv2.undistort()</code> function.</p>
<h4>Description of how I used color transforms, gradients or other methods to create a thresholded binary image.</h4>
<p>I used a combination of color and gradient thresholds to generate a binary image. </p>
<h4>Description of how I performed a perspective transform.</h4>
<p>The <code>unwarp_image()</code> function takes as inputs an image (<code>img</code>), as well as source (<code>src</code>) and destination (<code>dst</code>) points.  I chose to hardcode the source and destination points in the following manner:</p>
<div class="highlight"><pre><span></span>src = np.float32([[580,460],[710,460],[1150,720],[150,720]])
dst = np.float32([[offset1, offset3], 
                  [img_size[0]-offset1, offset3], 
                  [img_size[0]-offset1, img_size[1]-offset2], 
                  [offset1, img_size[1]-offset2]])
</pre></div>


<h4>Description of how I identified lane-line pixels and fit their positions with a polynomial.</h4>
<p>To find the position of the lanes, a histogram is generated from which I get a pair of peaks that represents the lanes. Then I do a sanity check that makes sure that those are indeed the lanes that I'm looking for. When my lanes are established, I use then go ahead and fit the pixels with a polynomal.</p>
<h4>Description of how I calculated the radius of curvature of the lane and the position of the vehicle with respect to center.</h4>
<p>This was done by first converting pixles into meters. The converstion coefficients were determined using the US Government requirements for the lane width and dashed line distance. Then I fitted a polynomial for each lane and determined the center. The polynomial derivatives are then calculated to get the curvature. </p>
<h4>Brief discussion on any problems / issues I faced in my implementation of this project.  Where will my pipeline likely fail?  What could I do to make it more robust?</h4>
<p>One of issues that I had with the implementation was tuning the hyperparameters to covert the image to binary. If this process was not done correctly, the pipeline did not do a good job at fitting the curve. If there is one place that the pipeless would fail, this would be it. If the lane pixels are not determined correctly, the fitted curve would be off. In order to make it more robust, I can implement a more stringent sanity check and put in place fail checks to correct for the mistakes.</p>
<h4>Link to my final video output.</h4>
<p>Here's a <a href="https://github.com/AmanMander123/AdvancedLaneFinding">link to my video result</a></p>
<h2>Camera Calibration</h2>
<div class="highlight"><pre><span></span><span class="c1"># Import libraries</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">cv2</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">matplotlib.image</span> <span class="kn">as</span> <span class="nn">mpimg</span>
<span class="o">%</span><span class="n">matplotlib</span> <span class="n">inline</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">signal</span>
<span class="kn">import</span> <span class="nn">math</span>

<span class="c1"># Define path to calibration and test files</span>
<span class="n">fnames</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;./camera_cal/calibration*.jpg&#39;</span><span class="p">)</span>
<span class="n">show_img</span> <span class="o">=</span> <span class="s1">&#39;./camera_cal/calibration{}.jpg&#39;</span>
<span class="n">test_fname</span> <span class="o">=</span> <span class="s1">&#39;./camera_cal/calibration1.jpg&#39;</span>
<span class="n">fnames</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">test_fname</span><span class="p">)</span>

<span class="c1"># Define number of corners</span>
<span class="n">nx</span> <span class="o">=</span> <span class="mi">9</span>
<span class="n">ny</span> <span class="o">=</span> <span class="mi">6</span>

<span class="c1"># Initialize object points</span>
<span class="n">objpoints</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nx</span> <span class="o">*</span> <span class="n">ny</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="n">objpoints</span><span class="p">[:,:</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mgrid</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">nx</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="n">ny</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>

<span class="n">imgpoints_vec</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">objpoints_vec</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># Loop through all calibration images</span>
<span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">fnames</span><span class="p">:</span>
    <span class="c1"># Read image</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>

    <span class="c1"># Convert images to greyscale</span>
    <span class="n">gray</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2GRAY</span><span class="p">)</span>

    <span class="c1"># Find the chessboard corners</span>
    <span class="n">ret</span><span class="p">,</span> <span class="n">corners</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">findChessboardCorners</span><span class="p">(</span><span class="n">gray</span><span class="p">,</span> <span class="p">(</span><span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">),</span> <span class="bp">None</span><span class="p">)</span>

    <span class="c1"># If found, draw corners</span>
    <span class="k">if</span> <span class="n">ret</span> <span class="o">==</span> <span class="bp">True</span><span class="p">:</span>
        <span class="n">imgpoints_vec</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">corners</span><span class="p">)</span>
        <span class="n">objpoints_vec</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">objpoints</span><span class="p">)</span>

        <span class="c1"># Draw and display the corners</span>
        <span class="k">if</span> <span class="n">fname</span> <span class="o">==</span> <span class="n">show_img</span><span class="p">:</span>
            <span class="n">img_corners</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">drawChessboardCorners</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="p">(</span><span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">),</span> <span class="n">corners</span><span class="p">,</span> <span class="n">ret</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img_corners</span><span class="p">)</span>

<span class="c1"># Test on test image</span>
<span class="n">test_img</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">test_fname</span><span class="p">)</span>
<span class="n">ret</span><span class="p">,</span> <span class="n">mtx</span><span class="p">,</span> <span class="n">dist</span><span class="p">,</span> <span class="n">rvecs</span><span class="p">,</span> <span class="n">tvecs</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">calibrateCamera</span><span class="p">(</span><span class="n">objpoints_vec</span><span class="p">,</span> <span class="n">imgpoints_vec</span><span class="p">,</span> <span class="n">test_img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">],</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">)</span>
<span class="n">undistorted</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">undistort</span><span class="p">(</span><span class="n">test_img</span><span class="p">,</span> <span class="n">mtx</span><span class="p">,</span> <span class="n">dist</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="n">mtx</span><span class="p">)</span>

<span class="n">f</span><span class="p">,</span> <span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">24</span><span class="p">,</span> <span class="mi">9</span><span class="p">))</span>
<span class="n">f</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">test_img</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Original Image&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">undistorted</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Undistorted Image&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">bottom</span><span class="o">=</span><span class="mf">0.</span><span class="p">)</span>
</pre></div>


<p><p></p> 
 <img src=/images/AdvancedLaneFinding_1_0.png width="600" height="200" />
 <p></p> </p>
<h2>Define Functions for Pipeline</h2>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">region_of_interest</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">vertices</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Applies an image mask.</span>

<span class="sd">    Only keeps the region of the image defined by the polygon</span>
<span class="sd">    formed from `vertices`. The rest of the image is set to black.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Defining a blank mask to start with</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>   

    <span class="c1"># Defining a 3 channel or 1 channel color to fill the mask with depending on the input image</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">channel_count</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>  <span class="c1"># i.e. 3 or 4 depending on your image</span>
        <span class="n">ignore_mask_color</span> <span class="o">=</span> <span class="p">(</span><span class="mi">255</span><span class="p">,)</span> <span class="o">*</span> <span class="n">channel_count</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ignore_mask_color</span> <span class="o">=</span> <span class="mi">255</span>

    <span class="c1"># Filling pixels inside the polygon defined by &quot;vertices&quot; with the fill color    </span>
    <span class="n">cv2</span><span class="o">.</span><span class="n">fillPoly</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">vertices</span><span class="p">,</span> <span class="n">ignore_mask_color</span><span class="p">)</span>

    <span class="c1"># Returning the image only where mask pixels are nonzero</span>
    <span class="n">masked_image</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">bitwise_and</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">mask</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">masked_image</span>

<span class="c1"># Function to apply Sobel</span>
<span class="k">def</span> <span class="nf">abs_sobel_thresh</span><span class="p">(</span><span class="n">gray</span><span class="p">,</span> <span class="n">orient</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">sobel_kernel</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">thresh</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">)):</span>
    <span class="c1"># Take the derivative in x</span>
    <span class="k">if</span> <span class="n">orient</span> <span class="o">==</span> <span class="s1">&#39;x&#39;</span><span class="p">:</span>
        <span class="n">sobel</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">Sobel</span><span class="p">(</span><span class="n">gray</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">CV_64F</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> 
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sobel</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">Sobel</span><span class="p">(</span><span class="n">gray</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">CV_64F</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> 

    <span class="c1"># Absolute x derivative to accentuate lines away from horizontal</span>
    <span class="n">abs_sobel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">absolute</span><span class="p">(</span><span class="n">sobel</span><span class="p">)</span> 
    <span class="n">scaled_sobel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">(</span><span class="mi">255</span><span class="o">*</span><span class="n">abs_sobel</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">abs_sobel</span><span class="p">))</span>

    <span class="c1"># Threshold gradient</span>
    <span class="n">sxbinary</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">scaled_sobel</span><span class="p">)</span>
    <span class="n">sxbinary</span><span class="p">[(</span><span class="n">scaled_sobel</span> <span class="o">&gt;=</span> <span class="n">thresh</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">scaled_sobel</span> <span class="o">&lt;=</span> <span class="n">thresh</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">sxbinary</span>

<span class="c1"># Function to compute the magnitude of the gradient</span>
<span class="k">def</span> <span class="nf">mag_thresh</span><span class="p">(</span><span class="n">gray</span><span class="p">,</span> <span class="n">sobel_kernel</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">mag_thresh</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">)):</span>
    <span class="c1"># Take both Sobel x and y gradients</span>
    <span class="n">sobelx</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">Sobel</span><span class="p">(</span><span class="n">gray</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">CV_64F</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ksize</span><span class="o">=</span><span class="n">sobel_kernel</span><span class="p">)</span>
    <span class="n">sobely</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">Sobel</span><span class="p">(</span><span class="n">gray</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">CV_64F</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ksize</span><span class="o">=</span><span class="n">sobel_kernel</span><span class="p">)</span>
    <span class="c1"># Calculate the gradient magnitude</span>
    <span class="n">gradmag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">sobelx</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">sobely</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="c1"># Rescale </span>
    <span class="n">scaled_gradmag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">(</span><span class="mi">255</span><span class="o">*</span><span class="n">gradmag</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">gradmag</span><span class="p">))</span>
    <span class="c1"># Create a binary image of ones where threshold is met, zeros otherwise</span>
    <span class="n">binary_output</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">scaled_gradmag</span><span class="p">)</span>
    <span class="n">binary_output</span><span class="p">[(</span><span class="n">scaled_gradmag</span> <span class="o">&gt;=</span> <span class="n">mag_thresh</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">scaled_gradmag</span> <span class="o">&lt;=</span> <span class="n">mag_thresh</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="c1"># Return the binary image</span>
    <span class="k">return</span> <span class="n">binary_output</span>

<span class="c1"># Function to threshold an image for a given range and Sobel kernel</span>
<span class="k">def</span> <span class="nf">dir_threshold</span><span class="p">(</span><span class="n">gray</span><span class="p">,</span> <span class="n">sobel_kernel</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">thresh</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">2</span><span class="p">)):</span>
    <span class="c1"># Calculate the x and y gradients</span>
    <span class="n">sobelx</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">Sobel</span><span class="p">(</span><span class="n">gray</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">CV_64F</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ksize</span><span class="o">=</span><span class="n">sobel_kernel</span><span class="p">)</span>
    <span class="n">sobely</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">Sobel</span><span class="p">(</span><span class="n">gray</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">CV_64F</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ksize</span><span class="o">=</span><span class="n">sobel_kernel</span><span class="p">)</span>
    <span class="c1"># Take the absolute value of the gradient direction, </span>
    <span class="c1"># apply a threshold, and create a binary image result</span>
    <span class="n">absgraddir</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">absolute</span><span class="p">(</span><span class="n">sobely</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">absolute</span><span class="p">(</span><span class="n">sobelx</span><span class="p">))</span>
    <span class="n">binary_output</span> <span class="o">=</span>  <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">absgraddir</span><span class="p">)</span>
    <span class="n">binary_output</span><span class="p">[(</span><span class="n">absgraddir</span> <span class="o">&gt;=</span> <span class="n">thresh</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">absgraddir</span> <span class="o">&lt;=</span> <span class="n">thresh</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="c1"># Return the binary image</span>
    <span class="k">return</span> <span class="n">binary_output</span>
</pre></div>


<h2>Create Pipeline</h2>
<div class="highlight"><pre><span></span><span class="c1"># Process image</span>
<span class="k">def</span> <span class="nf">pipeline</span><span class="p">(</span><span class="n">img</span><span class="p">):</span>
    <span class="c1"># Apply Gaussian Blur</span>
    <span class="n">kernel_size</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">GaussianBlur</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="p">(</span><span class="n">kernel_size</span><span class="p">,</span> <span class="n">kernel_size</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
    <span class="c1"># Convert to binary image</span>
    <span class="n">hls</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_RGB2HLS</span><span class="p">)</span>
    <span class="n">S</span> <span class="o">=</span> <span class="n">hls</span><span class="p">[:,:,</span><span class="mi">2</span><span class="p">]</span>
    <span class="c1"># Convert to grayscale</span>
    <span class="n">gray</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_RGB2GRAY</span><span class="p">)</span>
    <span class="c1"># Define Sobel kernel size</span>
    <span class="n">ksize</span> <span class="o">=</span> <span class="mi">7</span>
    <span class="c1"># Apply each of the thresholding functions</span>
    <span class="n">gradx</span> <span class="o">=</span> <span class="n">abs_sobel_thresh</span><span class="p">(</span><span class="n">gray</span><span class="p">,</span> <span class="n">orient</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">sobel_kernel</span><span class="o">=</span><span class="n">ksize</span><span class="p">,</span> <span class="n">thresh</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">250</span><span class="p">))</span>
    <span class="n">grady</span> <span class="o">=</span> <span class="n">abs_sobel_thresh</span><span class="p">(</span><span class="n">gray</span><span class="p">,</span> <span class="n">orient</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">sobel_kernel</span><span class="o">=</span><span class="n">ksize</span><span class="p">,</span> <span class="n">thresh</span><span class="o">=</span><span class="p">(</span><span class="mi">60</span><span class="p">,</span> <span class="mi">255</span><span class="p">))</span>
    <span class="n">mag_binary</span> <span class="o">=</span> <span class="n">mag_thresh</span><span class="p">(</span><span class="n">gray</span><span class="p">,</span> <span class="n">sobel_kernel</span><span class="o">=</span><span class="n">ksize</span><span class="p">,</span> <span class="n">mag_thresh</span><span class="o">=</span><span class="p">(</span><span class="mi">40</span><span class="p">,</span> <span class="mi">255</span><span class="p">))</span>
    <span class="n">dir_binary</span> <span class="o">=</span> <span class="n">dir_threshold</span><span class="p">(</span><span class="n">gray</span><span class="p">,</span> <span class="n">sobel_kernel</span><span class="o">=</span><span class="n">ksize</span><span class="p">,</span> <span class="n">thresh</span><span class="o">=</span><span class="p">(</span><span class="mf">0.65</span><span class="p">,</span> <span class="mf">1.05</span><span class="p">))</span>
    <span class="c1"># Combine thresholding information</span>
    <span class="n">combined</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">dir_binary</span><span class="p">)</span>
    <span class="n">combined</span><span class="p">[((</span><span class="n">gradx</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">grady</span> <span class="o">==</span> <span class="mi">1</span><span class="p">))</span> <span class="o">|</span> <span class="p">((</span><span class="n">mag_binary</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">dir_binary</span> <span class="o">==</span> <span class="mi">1</span><span class="p">))]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="c1"># Apply threshold to color channel</span>
    <span class="n">s_binary</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">combined</span><span class="p">)</span>
    <span class="n">s_binary</span><span class="p">[(</span><span class="n">S</span> <span class="o">&gt;</span> <span class="mi">160</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">S</span> <span class="o">&lt;</span> <span class="mi">255</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="c1"># Convert to binary images   </span>
    <span class="n">color_binary</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">combined</span><span class="p">)</span>
    <span class="n">color_binary</span><span class="p">[(</span><span class="n">s_binary</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">combined</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="c1"># Define vertices for marked area</span>
    <span class="n">left_b</span> <span class="o">=</span> <span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">right_b</span> <span class="o">=</span> <span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">20</span><span class="p">,</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">apex1</span> <span class="o">=</span> <span class="p">(</span><span class="mi">610</span><span class="p">,</span> <span class="mi">410</span><span class="p">)</span>
    <span class="n">apex2</span> <span class="o">=</span> <span class="p">(</span><span class="mi">680</span><span class="p">,</span> <span class="mi">410</span><span class="p">)</span>
    <span class="n">inner_left_b</span> <span class="o">=</span> <span class="p">(</span><span class="mi">310</span><span class="p">,</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">inner_right_b</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1150</span><span class="p">,</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">inner_apex1</span> <span class="o">=</span> <span class="p">(</span><span class="mi">700</span><span class="p">,</span><span class="mi">480</span><span class="p">)</span>
    <span class="n">inner_apex2</span> <span class="o">=</span> <span class="p">(</span><span class="mi">650</span><span class="p">,</span><span class="mi">480</span><span class="p">)</span>
    <span class="n">vertices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">left_b</span><span class="p">,</span> <span class="n">apex1</span><span class="p">,</span> <span class="n">apex2</span><span class="p">,</span> <span class="n">right_b</span><span class="p">,</span> <span class="n">inner_right_b</span><span class="p">,</span> \
                          <span class="n">inner_apex1</span><span class="p">,</span> <span class="n">inner_apex2</span><span class="p">,</span> <span class="n">inner_left_b</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
    <span class="c1"># Select region of interest</span>
    <span class="n">color_binary</span> <span class="o">=</span> <span class="n">region_of_interest</span><span class="p">(</span><span class="n">color_binary</span><span class="p">,</span> <span class="n">vertices</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">color_binary</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">7</span><span class="p">):</span>
    <span class="n">fname</span> <span class="o">=</span> <span class="s1">&#39;./test_images/test{}.jpg&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
    <span class="n">processed_img</span> <span class="o">=</span> <span class="n">pipeline</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>

    <span class="c1"># Plot the result</span>
    <span class="n">f</span><span class="p">,</span> <span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
    <span class="n">f</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

    <span class="n">ax1</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Original Image&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>

    <span class="n">ax2</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">processed_img</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Processed Image&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">bottom</span><span class="o">=</span><span class="mf">0.</span><span class="p">)</span>
</pre></div>


<p><p></p> 
 <img src=/images/AdvancedLaneFinding_5_0.png width="600" height="200" />
 <p></p> </p>
<p><p></p> 
 <img src=/images/AdvancedLaneFinding_5_1.png width="600" height="200" />
 <p></p> </p>
<p><p></p> 
 <img src=/images/AdvancedLaneFinding_5_2.png width="600" height="200" />
 <p></p> </p>
<p><p></p> 
 <img src=/images/AdvancedLaneFinding_5_3.png width="600" height="200" />
 <p></p> </p>
<p><p></p> 
 <img src=/images/AdvancedLaneFinding_5_4.png width="600" height="200" />
 <p></p> </p>
<p><p></p> 
 <img src=/images/AdvancedLaneFinding_5_5.png width="600" height="200" />
 <p></p> </p>
<h2>Define Line Class</h2>
<div class="highlight"><pre><span></span><span class="c1"># Define a class to receive the characteristics of each line detection</span>
<span class="k">class</span> <span class="nc">Line</span><span class="p">():</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># was the line detected in the last iteration?</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">detected</span> <span class="o">=</span> <span class="bp">False</span>  
        <span class="c1"># x values of the last n fits of the line</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">recent_xfitted</span> <span class="o">=</span> <span class="p">[]</span> 
        <span class="c1">#average x values of the fitted line over the last n iterations</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bestx</span> <span class="o">=</span> <span class="bp">None</span>     
        <span class="c1">#polynomial coefficients averaged over the last n iterations</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">best_fit</span> <span class="o">=</span> <span class="bp">None</span>  
        <span class="c1">#polynomial coefficients for the most recent fit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_fit</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">False</span><span class="p">])]</span>  
        <span class="c1">#radius of curvature of the line in some units</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">radius_of_curvature</span> <span class="o">=</span> <span class="bp">None</span> 
        <span class="c1">#distance in meters of vehicle center from the line</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">line_base_pos</span> <span class="o">=</span> <span class="bp">None</span> 
        <span class="c1">#difference in fit coefficients between last and new fits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">diffs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float&#39;</span><span class="p">)</span> 
        <span class="c1">#x values for detected line pixels</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">allx</span> <span class="o">=</span> <span class="bp">None</span>  
        <span class="c1">#y values for detected line pixels</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ally</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="c1">#x values in windows</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">windows</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span><span class="mi">12</span><span class="p">))</span><span class="o">*-</span><span class="mi">1</span>
</pre></div>


<h2>Define Functions for Finding Lanes</h2>
<div class="highlight"><pre><span></span><span class="c1"># Define area of interest</span>
<span class="n">area_of_interest</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">580</span><span class="p">,</span><span class="mi">460</span><span class="p">],[</span><span class="mi">710</span><span class="p">,</span><span class="mi">460</span><span class="p">],[</span><span class="mi">1150</span><span class="p">,</span><span class="mi">720</span><span class="p">],[</span><span class="mi">150</span><span class="p">,</span><span class="mi">720</span><span class="p">]]</span>

<span class="c1"># Define function to unwarp image</span>
<span class="k">def</span> <span class="nf">unwarp_image</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">mtx</span><span class="p">,</span> <span class="n">dist</span><span class="p">):</span>
    <span class="c1"># Remove distortion from image</span>
    <span class="n">undistorted_img</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">undistort</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">mtx</span><span class="p">,</span> <span class="n">dist</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="n">mtx</span><span class="p">)</span>
    <span class="c1"># Choose offsets from image corners</span>
    <span class="n">offset1</span> <span class="o">=</span> <span class="mi">200</span>
    <span class="n">offset2</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">offset3</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="c1"># Get image shape</span>
    <span class="n">img_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">gray</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">gray</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="c1"># Get source and destination points</span>
    <span class="n">src</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">([[</span><span class="mi">580</span><span class="p">,</span><span class="mi">460</span><span class="p">],[</span><span class="mi">710</span><span class="p">,</span><span class="mi">460</span><span class="p">],[</span><span class="mi">1150</span><span class="p">,</span><span class="mi">720</span><span class="p">],[</span><span class="mi">150</span><span class="p">,</span><span class="mi">720</span><span class="p">]])</span>
    <span class="n">dst</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">([[</span><span class="n">offset1</span><span class="p">,</span> <span class="n">offset3</span><span class="p">],</span> 
                      <span class="p">[</span><span class="n">img_size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">offset1</span><span class="p">,</span> <span class="n">offset3</span><span class="p">],</span> 
                      <span class="p">[</span><span class="n">img_size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">offset1</span><span class="p">,</span> <span class="n">img_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">offset2</span><span class="p">],</span> 
                      <span class="p">[</span><span class="n">offset1</span><span class="p">,</span> <span class="n">img_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">offset2</span><span class="p">]])</span>

    <span class="c1"># Given src and dst points, calculate the perspective transform matrix</span>
    <span class="n">M</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">getPerspectiveTransform</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">)</span>
    <span class="n">M_inv</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">getPerspectiveTransform</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">src</span><span class="p">)</span>
    <span class="c1"># Get warped image</span>
    <span class="n">warped</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">warpPerspective</span><span class="p">(</span><span class="n">undistorted_img</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">img_size</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">warped</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">M_inv</span>


<span class="c1"># Define function to fit curve to lane</span>
<span class="k">def</span> <span class="nf">get_curvature</span><span class="p">(</span><span class="n">yvals</span><span class="p">,</span> <span class="n">fitx</span><span class="p">):</span>
    <span class="c1"># y-value location of radius of curvature</span>
    <span class="n">y_eval</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">yvals</span><span class="p">)</span>
    <span class="c1"># Define conversions in x and y from pixels space to meters</span>
    <span class="n">ym_per_pix</span> <span class="o">=</span> <span class="mi">30</span><span class="o">/</span><span class="mi">720</span> <span class="c1"># meters per pixel in y dimension</span>
    <span class="n">xm_per_pix</span> <span class="o">=</span> <span class="mf">3.7</span><span class="o">/</span><span class="mi">700</span> <span class="c1"># meteres per pixel in x dimension</span>
    <span class="n">fit_cr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="n">yvals</span><span class="o">*</span><span class="n">ym_per_pix</span><span class="p">,</span> <span class="n">fitx</span><span class="o">*</span><span class="n">xm_per_pix</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">curverad</span> <span class="o">=</span> <span class="p">((</span><span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">fit_cr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">y_eval</span> <span class="o">+</span> <span class="n">fit_cr</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mf">1.5</span><span class="p">)</span> \
                                 <span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">absolute</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">fit_cr</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">curverad</span>

<span class="c1"># Define function to get position</span>
<span class="k">def</span> <span class="nf">get_position</span><span class="p">(</span><span class="n">img</span><span class="p">,</span><span class="n">pts</span><span class="p">):</span>
    <span class="c1"># Find position of car from center</span>
    <span class="n">image_shape</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">position</span> <span class="o">=</span> <span class="n">image_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span>
    <span class="n">left</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">pts</span><span class="p">[(</span><span class="n">pts</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">position</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">pts</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">700</span><span class="p">)][:,</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">right</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">pts</span><span class="p">[(</span><span class="n">pts</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">position</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">pts</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">700</span><span class="p">)][:,</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">center</span> <span class="o">=</span> <span class="p">(</span><span class="n">left</span> <span class="o">+</span> <span class="n">right</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
    <span class="c1"># Define conversions in x and y from pixels space to meters</span>
    <span class="n">xm_per_pix</span> <span class="o">=</span> <span class="mf">3.7</span><span class="o">/</span><span class="mi">700</span> <span class="c1"># meteres per pixel in x dimension    </span>
    <span class="k">return</span> <span class="p">(</span><span class="n">position</span> <span class="o">-</span> <span class="n">center</span><span class="p">)</span><span class="o">*</span><span class="n">xm_per_pix</span>

<span class="c1"># Define function to find nearest point from array</span>
<span class="k">def</span> <span class="nf">get_nearest</span><span class="p">(</span><span class="n">array</span><span class="p">,</span><span class="n">value</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">array</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">array</span><span class="o">-</span><span class="n">value</span><span class="p">))</span><span class="o">.</span><span class="n">argmin</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">array</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>

<span class="c1"># Find the historgram from image and get max</span>
<span class="k">def</span> <span class="nf">get_peaks</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">ytop</span><span class="p">,</span> <span class="n">ybottom</span><span class="p">,</span> <span class="n">xleft</span><span class="p">,</span> <span class="n">xright</span><span class="p">):</span>

    <span class="n">histogram</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">img</span><span class="p">[</span><span class="n">ytop</span><span class="p">:</span><span class="n">ybottom</span><span class="p">,:],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="c1"># Get max</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">histogram</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">xleft</span><span class="p">):</span><span class="nb">int</span><span class="p">(</span><span class="n">xright</span><span class="p">)])</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">histogram</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">xleft</span><span class="p">):</span><span class="nb">int</span><span class="p">(</span><span class="n">xright</span><span class="p">)])</span> <span class="o">+</span> <span class="n">xleft</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">xleft</span> <span class="o">+</span> <span class="n">xright</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>  

<span class="c1"># Define function for sanity check</span>
<span class="k">def</span> <span class="nf">sanity_check</span><span class="p">(</span><span class="n">lane</span><span class="p">,</span> <span class="n">curverad</span><span class="p">,</span> <span class="n">fitx</span><span class="p">,</span> <span class="n">fit</span><span class="p">):</span>       
    <span class="c1"># If lane is detected</span>
    <span class="k">if</span> <span class="n">lane</span><span class="o">.</span><span class="n">detected</span><span class="p">:</span> 
        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">curverad</span> <span class="o">/</span> <span class="n">lane</span><span class="o">.</span><span class="n">radius_of_curvature</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="o">.</span><span class="mi">6</span><span class="p">:</span>        
            <span class="n">lane</span><span class="o">.</span><span class="n">detected</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="n">lane</span><span class="o">.</span><span class="n">current_fit</span> <span class="o">=</span> <span class="n">fit</span>
            <span class="n">lane</span><span class="o">.</span><span class="n">allx</span> <span class="o">=</span> <span class="n">fitx</span>
            <span class="n">lane</span><span class="o">.</span><span class="n">bestx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">fitx</span><span class="p">)</span>            
            <span class="n">lane</span><span class="o">.</span><span class="n">radius_of_curvature</span> <span class="o">=</span> <span class="n">curverad</span>
            <span class="n">lane</span><span class="o">.</span><span class="n">current_fit</span> <span class="o">=</span> <span class="n">fit</span>
        <span class="c1"># Else use the previous values</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lane</span><span class="o">.</span><span class="n">detected</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="n">fitx</span> <span class="o">=</span> <span class="n">lane</span><span class="o">.</span><span class="n">allx</span>
    <span class="c1"># If lane not detected and no curvature defined</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">lane</span><span class="o">.</span><span class="n">radius_of_curvature</span><span class="p">:</span> 
            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">curverad</span> <span class="o">/</span> <span class="n">lane</span><span class="o">.</span><span class="n">radius_of_curvature</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>            
                <span class="n">lane</span><span class="o">.</span><span class="n">detected</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="n">lane</span><span class="o">.</span><span class="n">current_fit</span> <span class="o">=</span> <span class="n">fit</span>
                <span class="n">lane</span><span class="o">.</span><span class="n">allx</span> <span class="o">=</span> <span class="n">fitx</span>
                <span class="n">lane</span><span class="o">.</span><span class="n">bestx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">fitx</span><span class="p">)</span>            
                <span class="n">lane</span><span class="o">.</span><span class="n">radius_of_curvature</span> <span class="o">=</span> <span class="n">curverad</span>
                <span class="n">lane</span><span class="o">.</span><span class="n">current_fit</span> <span class="o">=</span> <span class="n">fit</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">lane</span><span class="o">.</span><span class="n">detected</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="n">fitx</span> <span class="o">=</span> <span class="n">lane</span><span class="o">.</span><span class="n">allx</span>      
        <span class="c1"># If curvature defined</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lane</span><span class="o">.</span><span class="n">detected</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="n">lane</span><span class="o">.</span><span class="n">current_fit</span> <span class="o">=</span> <span class="n">fit</span>
            <span class="n">lane</span><span class="o">.</span><span class="n">allx</span> <span class="o">=</span> <span class="n">fitx</span>
            <span class="n">lane</span><span class="o">.</span><span class="n">bestx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">fitx</span><span class="p">)</span>
            <span class="n">lane</span><span class="o">.</span><span class="n">radius_of_curvature</span> <span class="o">=</span> <span class="n">curverad</span>
    <span class="k">return</span> <span class="n">fitx</span>

<span class="c1"># Sanity check for the direction</span>
<span class="k">def</span> <span class="nf">sanity_check_direction</span><span class="p">(</span><span class="n">right</span><span class="p">,</span> <span class="n">right_pre</span><span class="p">,</span> <span class="n">right_pre_pre</span><span class="p">):</span>
    <span class="c1"># Pass if correct direction</span>
    <span class="k">if</span> <span class="nb">abs</span><span class="p">((</span><span class="n">right</span><span class="o">-</span><span class="n">right_pre</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">right_pre</span><span class="o">-</span><span class="n">right_pre_pre</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="o">.</span><span class="mi">2</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">right</span>
    <span class="c1"># Else use the previous values</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">right_pre</span> <span class="o">+</span> <span class="p">(</span><span class="n">right_pre</span> <span class="o">-</span> <span class="n">right_pre_pre</span><span class="p">)</span>

<span class="c1"># Define function to find lines</span>
<span class="k">def</span> <span class="nf">get_lanes</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">img</span><span class="p">,</span> <span class="n">x_window</span><span class="p">,</span> <span class="n">lanes</span><span class="p">,</span> <span class="n">left_x</span><span class="p">,</span> <span class="n">left_y</span><span class="p">,</span> <span class="n">right_x</span><span class="p">,</span> <span class="n">right_y</span><span class="p">,</span> <span class="n">segment_ind</span><span class="p">):</span>
    <span class="n">point1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
    <span class="n">point1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">300</span><span class="p">,</span> <span class="mi">1100</span><span class="p">]</span>
    <span class="n">point1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">300</span><span class="p">,</span> <span class="mi">1100</span><span class="p">]</span>
    <span class="c1"># Assign left and right values</span>
    <span class="n">left</span><span class="p">,</span> <span class="n">right</span> <span class="o">=</span> <span class="p">(</span><span class="mi">300</span><span class="p">,</span> <span class="mi">1100</span><span class="p">)</span>
    <span class="c1"># Assign center</span>
    <span class="n">center</span> <span class="o">=</span> <span class="mi">700</span>
    <span class="c1"># Assign previous center</span>
    <span class="n">center_pre</span> <span class="o">=</span> <span class="n">center</span>
    <span class="c1"># Assign direction</span>
    <span class="n">direction</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="c1"># Set range</span>
        <span class="n">y_top</span> <span class="o">=</span> <span class="mi">720</span><span class="o">-</span><span class="mi">720</span><span class="o">/</span><span class="n">n</span><span class="o">*</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">y_bottom</span> <span class="o">=</span> <span class="mi">720</span><span class="o">-</span><span class="mi">720</span><span class="o">/</span><span class="n">n</span><span class="o">*</span><span class="n">i</span>
        <span class="c1"># If left and right lanes detected</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">left_lane</span><span class="o">.</span><span class="n">detected</span><span class="o">==</span><span class="bp">False</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">right_lane</span><span class="o">.</span><span class="n">detected</span><span class="o">==</span><span class="bp">False</span><span class="p">):</span>
            <span class="c1"># Get histogram</span>
            <span class="n">left</span>  <span class="o">=</span> <span class="n">get_peaks</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">y_top</span><span class="p">,</span> <span class="n">y_bottom</span><span class="p">,</span> <span class="n">point1</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">200</span><span class="p">,</span> <span class="n">point1</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">200</span><span class="p">)</span>
            <span class="n">right</span> <span class="o">=</span> <span class="n">get_peaks</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">y_top</span><span class="p">,</span> <span class="n">y_bottom</span><span class="p">,</span> <span class="n">point1</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">200</span><span class="p">,</span> <span class="n">point1</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">200</span><span class="p">)</span>
            <span class="c1"># Set direction</span>
            <span class="n">left</span>  <span class="o">=</span> <span class="n">sanity_check_direction</span><span class="p">(</span><span class="n">left</span><span class="p">,</span> <span class="n">point1</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">point1</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">right</span> <span class="o">=</span> <span class="n">sanity_check_direction</span><span class="p">(</span><span class="n">right</span><span class="p">,</span> <span class="n">point1</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">point1</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span> 
            <span class="c1"># Set center</span>
            <span class="n">center_pre</span> <span class="o">=</span> <span class="n">center</span>
            <span class="n">center</span> <span class="o">=</span> <span class="p">(</span><span class="n">left</span> <span class="o">+</span> <span class="n">right</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
            <span class="n">direction</span> <span class="o">=</span> <span class="n">center</span> <span class="o">-</span> <span class="n">center_pre</span>
        <span class="c1"># If both lanes detected </span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">left</span>  <span class="o">=</span> <span class="n">left_lane</span><span class="o">.</span><span class="n">windows</span><span class="p">[</span><span class="n">segment_ind</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span>
            <span class="n">right</span> <span class="o">=</span> <span class="n">right_lane</span><span class="o">.</span><span class="n">windows</span><span class="p">[</span><span class="n">segment_ind</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span>
        <span class="c1"># Double check distance between lanes</span>
        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">left</span><span class="o">-</span><span class="n">right</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">600</span><span class="p">:</span>
            <span class="c1"># Add coordinates to left lane arrays</span>
            <span class="n">left_lane_array</span> <span class="o">=</span> <span class="n">lanes</span><span class="p">[(</span><span class="n">lanes</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">&gt;=</span><span class="n">left</span><span class="o">-</span><span class="n">x_window</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">lanes</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">&lt;</span><span class="n">left</span><span class="o">+</span><span class="n">x_window</span><span class="p">)</span> <span class="o">&amp;</span>
                                 <span class="p">(</span><span class="n">lanes</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">&lt;=</span><span class="n">y_bottom</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">lanes</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">&gt;=</span><span class="n">y_top</span><span class="p">)]</span>
            <span class="n">left_x</span> <span class="o">+=</span> <span class="n">left_lane_array</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="n">left_y</span> <span class="o">+=</span> <span class="n">left_lane_array</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">math</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">left_lane_array</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])):</span>
                <span class="n">left_lane</span><span class="o">.</span><span class="n">windows</span><span class="p">[</span><span class="n">segment_ind</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">left_lane_array</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">point1</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">left_lane_array</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">point1</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">point1</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">direction</span>
                <span class="n">left_lane</span><span class="o">.</span><span class="n">windows</span><span class="p">[</span><span class="n">segment_ind</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">point1</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
            <span class="c1"># Append coordinates to the right lane arrays            </span>
            <span class="n">right_lane_array</span> <span class="o">=</span> <span class="n">lanes</span><span class="p">[(</span><span class="n">lanes</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">&gt;=</span><span class="n">right</span><span class="o">-</span><span class="n">x_window</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">lanes</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">&lt;</span><span class="n">right</span><span class="o">+</span><span class="n">x_window</span><span class="p">)</span> <span class="o">&amp;</span>
                                  <span class="p">(</span><span class="n">lanes</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">&lt;</span><span class="n">y_bottom</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">lanes</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">&gt;=</span><span class="n">y_top</span><span class="p">)]</span>
            <span class="n">right_x</span> <span class="o">+=</span> <span class="n">right_lane_array</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="n">right_y</span> <span class="o">+=</span> <span class="n">right_lane_array</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">math</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">right_lane_array</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])):</span>
                <span class="n">right_lane</span><span class="o">.</span><span class="n">windows</span><span class="p">[</span><span class="n">segment_ind</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">right_lane_array</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">point1</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">right_lane_array</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">point1</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">point1</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">direction</span>
                <span class="n">right_lane</span><span class="o">.</span><span class="n">windows</span><span class="p">[</span><span class="n">segment_ind</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">point1</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">left_x</span><span class="p">,</span> <span class="n">left_y</span><span class="p">,</span> <span class="n">right_x</span><span class="p">,</span> <span class="n">right_y</span>

<span class="k">def</span> <span class="nf">fit_lanes</span><span class="p">(</span><span class="n">img</span><span class="p">):</span>
    <span class="c1"># Define y values for plotting</span>
    <span class="n">yvals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">101</span><span class="p">)</span><span class="o">*</span><span class="mf">7.2</span> 
    <span class="c1"># Get coordinates from image</span>
    <span class="n">lanes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
    <span class="c1"># Coordinates for left lane</span>
    <span class="n">left_x</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">left_y</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># Coordinates for right lane</span>
    <span class="n">right_x</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">right_y</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># Initialize curve</span>
    <span class="n">curve</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="c1"># Assign left and right as None</span>
    <span class="n">left</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">right</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="c1"># Find lanes</span>
    <span class="n">left_x</span><span class="p">,</span> <span class="n">left_y</span><span class="p">,</span> <span class="n">right_x</span><span class="p">,</span> <span class="n">right_y</span> <span class="o">=</span> <span class="n">get_lanes</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">img</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="n">lanes</span><span class="p">,</span> \
                                    <span class="n">left_x</span><span class="p">,</span> <span class="n">left_y</span><span class="p">,</span> <span class="n">right_x</span><span class="p">,</span> <span class="n">right_y</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">left_x</span><span class="p">,</span> <span class="n">left_y</span><span class="p">,</span> <span class="n">right_x</span><span class="p">,</span> <span class="n">right_y</span> <span class="o">=</span> <span class="n">get_lanes</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="n">img</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="n">lanes</span><span class="p">,</span> \
                     <span class="n">left_x</span><span class="p">,</span> <span class="n">left_y</span><span class="p">,</span> <span class="n">right_x</span><span class="p">,</span> <span class="n">right_y</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">left_x</span><span class="p">,</span> <span class="n">left_y</span><span class="p">,</span> <span class="n">right_x</span><span class="p">,</span> <span class="n">right_y</span> <span class="o">=</span> <span class="n">get_lanes</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="n">img</span><span class="p">,</span> <span class="mi">75</span><span class="p">,</span> <span class="n">lanes</span><span class="p">,</span> \
                     <span class="n">left_x</span><span class="p">,</span> <span class="n">left_y</span><span class="p">,</span> <span class="n">right_x</span><span class="p">,</span> <span class="n">right_y</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

    <span class="c1"># Get coefficients of polynomials</span>
    <span class="n">left_fit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="n">left_y</span><span class="p">,</span> <span class="n">left_x</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">left_fitx</span> <span class="o">=</span> <span class="n">left_fit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">yvals</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">left_fit</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">yvals</span> <span class="o">+</span> <span class="n">left_fit</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">right_fit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="n">right_y</span><span class="p">,</span> <span class="n">right_x</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">right_fitx</span> <span class="o">=</span> <span class="n">right_fit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">yvals</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">right_fit</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">yvals</span> <span class="o">+</span> <span class="n">right_fit</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="c1"># Find curvatures</span>
    <span class="n">left_curverad</span>  <span class="o">=</span> <span class="n">get_curvature</span><span class="p">(</span><span class="n">yvals</span><span class="p">,</span> <span class="n">left_fitx</span><span class="p">)</span>
    <span class="n">right_curverad</span> <span class="o">=</span> <span class="n">get_curvature</span><span class="p">(</span><span class="n">yvals</span><span class="p">,</span> <span class="n">right_fitx</span><span class="p">)</span>
    <span class="c1"># Do sanity checks</span>
    <span class="n">left_fitx</span>  <span class="o">=</span> <span class="n">sanity_check</span><span class="p">(</span><span class="n">left_lane</span><span class="p">,</span> <span class="n">left_curverad</span><span class="p">,</span> <span class="n">left_fitx</span><span class="p">,</span> <span class="n">left_fit</span><span class="p">)</span>
    <span class="n">right_fitx</span> <span class="o">=</span> <span class="n">sanity_check</span><span class="p">(</span><span class="n">right_lane</span><span class="p">,</span> <span class="n">right_curverad</span><span class="p">,</span> <span class="n">right_fitx</span><span class="p">,</span> <span class="n">right_fit</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">yvals</span><span class="p">,</span> <span class="n">left_fitx</span><span class="p">,</span> <span class="n">right_fitx</span><span class="p">,</span> <span class="n">left_x</span><span class="p">,</span> <span class="n">left_y</span><span class="p">,</span> <span class="n">right_x</span><span class="p">,</span> <span class="n">right_y</span><span class="p">,</span> <span class="n">left_curverad</span>

<span class="c1"># Define function to draw polynomial on an image</span>
<span class="k">def</span> <span class="nf">draw_poly</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">warped</span><span class="p">,</span> <span class="n">yvals</span><span class="p">,</span> <span class="n">left_fitx</span><span class="p">,</span> <span class="n">right_fitx</span><span class="p">,</span> 
              <span class="n">left_x</span><span class="p">,</span> <span class="n">left_y</span><span class="p">,</span> <span class="n">right_x</span><span class="p">,</span> <span class="n">right_y</span><span class="p">,</span> <span class="n">Minv</span><span class="p">,</span> <span class="n">curvature</span><span class="p">):</span>
    <span class="c1"># Create an image to draw the lines on</span>
    <span class="n">warp_zero</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">warped</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
    <span class="n">color_warp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dstack</span><span class="p">((</span><span class="n">warp_zero</span><span class="p">,</span> <span class="n">warp_zero</span><span class="p">,</span> <span class="n">warp_zero</span><span class="p">))</span>
    <span class="c1"># Recast the x and y points into usable format for cv2.fillPoly()</span>
    <span class="n">pts_left</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">left_fitx</span><span class="p">,</span> <span class="n">yvals</span><span class="p">]))])</span>
    <span class="n">pts_right</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">flipud</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">right_fitx</span><span class="p">,</span> <span class="n">yvals</span><span class="p">])))])</span>
    <span class="n">pts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">pts_left</span><span class="p">,</span> <span class="n">pts_right</span><span class="p">))</span>
    <span class="c1"># Draw the lane onto the warped blank image</span>
    <span class="n">cv2</span><span class="o">.</span><span class="n">fillPoly</span><span class="p">(</span><span class="n">color_warp</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int_</span><span class="p">([</span><span class="n">pts</span><span class="p">]),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
    <span class="c1"># Warp the blank back to original image space using inverse perspective matrix (Minv)</span>
    <span class="n">newwarp</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">warpPerspective</span><span class="p">(</span><span class="n">color_warp</span><span class="p">,</span> <span class="n">Minv</span><span class="p">,</span> <span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> 
    <span class="c1"># Combine the result with the original image</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">addWeighted</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">newwarp</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="c1"># Put text on an image</span>
    <span class="n">font</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">FONT_HERSHEY_PLAIN</span>
    <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;Radius of Curvature: {} m&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">curvature</span><span class="p">))</span>
    <span class="n">cv2</span><span class="o">.</span><span class="n">putText</span><span class="p">(</span><span class="n">result</span><span class="p">,</span><span class="n">text</span><span class="p">,(</span><span class="mi">400</span><span class="p">,</span><span class="mi">100</span><span class="p">),</span> <span class="n">font</span><span class="p">,</span> <span class="mi">1</span><span class="p">,(</span><span class="mi">255</span><span class="p">,</span><span class="mi">255</span><span class="p">,</span><span class="mi">255</span><span class="p">),</span><span class="mi">2</span><span class="p">)</span>
    <span class="c1"># Find the position of the car</span>
    <span class="n">pts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">newwarp</span><span class="p">[:,:,</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">position</span> <span class="o">=</span> <span class="n">get_position</span><span class="p">(</span><span class="n">img</span><span class="p">,</span><span class="n">pts</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">position</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;Vehicle is {:.2f} m left of center&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">-</span><span class="n">position</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;Vehicle is {:.2f} m right of center&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">position</span><span class="p">)</span>
    <span class="n">cv2</span><span class="o">.</span><span class="n">putText</span><span class="p">(</span><span class="n">result</span><span class="p">,</span><span class="n">text</span><span class="p">,(</span><span class="mi">400</span><span class="p">,</span><span class="mi">150</span><span class="p">),</span> <span class="n">font</span><span class="p">,</span> <span class="mi">1</span><span class="p">,(</span><span class="mi">255</span><span class="p">,</span><span class="mi">255</span><span class="p">,</span><span class="mi">255</span><span class="p">),</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span>
</pre></div>


<h2>Define Function to Process Image</h2>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">process_image</span><span class="p">(</span><span class="n">image</span><span class="p">):</span>
    <span class="c1"># Put image through pipline</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">pipeline</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
    <span class="c1"># Warp image to make lanes parallel to each other</span>
    <span class="n">birds_eye</span><span class="p">,</span> <span class="n">perspective_M</span><span class="p">,</span> <span class="n">perspective_Minv</span> <span class="o">=</span> <span class="n">unwarp_image</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">mtx</span><span class="p">,</span> <span class="n">dist</span><span class="p">)</span>
    <span class="c1"># Find the lines</span>
    <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">lx</span><span class="p">,</span> <span class="n">ly</span><span class="p">,</span> <span class="n">rx</span><span class="p">,</span> <span class="n">ry</span><span class="p">,</span> <span class="n">curvature</span> <span class="o">=</span> <span class="n">fit_lanes</span><span class="p">(</span><span class="n">birds_eye</span><span class="p">)</span>
    <span class="c1"># Return original image with colored region</span>
    <span class="k">return</span> <span class="n">draw_poly</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">birds_eye</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">lx</span><span class="p">,</span> <span class="n">ly</span><span class="p">,</span> <span class="n">rx</span><span class="p">,</span> <span class="n">ry</span><span class="p">,</span> <span class="n">perspective_Minv</span><span class="p">,</span> <span class="n">curvature</span><span class="p">)</span>
</pre></div>


<h2>Draw Images</h2>
<div class="highlight"><pre><span></span><span class="c1"># Hide warnings</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>

<span class="c1"># Used to plot lines on images</span>
<span class="n">x_values</span> <span class="o">=</span> <span class="p">[</span><span class="n">area_of_interest</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">area_of_interest</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">area_of_interest</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">area_of_interest</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">area_of_interest</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span>
<span class="n">y_values</span> <span class="o">=</span> <span class="p">[</span><span class="n">area_of_interest</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="n">area_of_interest</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="n">area_of_interest</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="n">area_of_interest</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="n">area_of_interest</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]]</span>

<span class="c1"># Loop through test images</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">7</span><span class="p">):</span>
    <span class="c1"># Initialize lines for left and right</span>
    <span class="n">left_lane</span> <span class="o">=</span> <span class="n">Line</span><span class="p">()</span>
    <span class="n">right_lane</span> <span class="o">=</span> <span class="n">Line</span><span class="p">()</span>
    <span class="c1"># Load image</span>
    <span class="n">fname</span> <span class="o">=</span> <span class="s1">&#39;test_images/test{}.jpg&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
    <span class="n">img_raw</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
    <span class="c1"># Apply pipeline to the image to create binary image</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">pipeline</span><span class="p">(</span><span class="n">img_raw</span><span class="p">)</span>
    <span class="c1"># Unwrap the image</span>
    <span class="n">birds_eye</span><span class="p">,</span> <span class="n">perspective_M</span><span class="p">,</span> <span class="n">perspective_Minv</span> <span class="o">=</span> <span class="n">unwarp_image</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">mtx</span><span class="p">,</span> <span class="n">dist</span><span class="p">)</span>
    <span class="c1"># Set Subplots</span>
    <span class="n">f</span><span class="p">,</span> <span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">,</span> <span class="n">ax3</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">24</span><span class="p">,</span> <span class="mi">9</span><span class="p">))</span>
    <span class="n">f</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="c1"># Show image </span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Binary Image&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_values</span><span class="p">,</span><span class="n">y_values</span><span class="p">,</span><span class="s1">&#39;r-&#39;</span><span class="p">,</span><span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
    <span class="c1"># Find lanes </span>
    <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">fit_lanes</span><span class="p">(</span><span class="n">birds_eye</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">birds_eye</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Undistorted Image&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
    <span class="c1"># Set up lines for left and right</span>
    <span class="n">left_lane</span> <span class="o">=</span> <span class="n">Line</span><span class="p">()</span>
    <span class="n">right_lane</span> <span class="o">=</span> <span class="n">Line</span><span class="p">()</span>    
    <span class="c1"># Color lanes</span>
    <span class="n">image_color</span> <span class="o">=</span> <span class="n">process_image</span><span class="p">(</span><span class="n">img_raw</span><span class="p">)</span>
    <span class="n">ax3</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">image_color</span><span class="p">)</span>
    <span class="n">ax3</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Colored Image&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
    <span class="c1"># Adjust subplots</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">bottom</span><span class="o">=</span><span class="mf">0.</span><span class="p">)</span>
</pre></div>


<p><p></p> 
 <img src=/images/AdvancedLaneFinding_13_0 width="600" height="200" />
 <p></p> </p>
<p><p></p> 
 <img src=/images/AdvancedLaneFinding_13_1.png width="600" height="200" />
 <p></p> </p>
<p><p></p> 
 <img src=/images/AdvancedLaneFinding_13_2.png width="600" height="200" />
 <p></p> </p>
<p><p></p> 
 <img src=/images/AdvancedLaneFinding_13_3.png width="600" height="200" />
 <p></p> </p>
<p><p></p> 
 <img src=/images/AdvancedLaneFinding_13_4.png width="600" height="200" />
 <p></p> </p>
<p><p></p> 
 <img src=/images/AdvancedLaneFinding_13_5.png width="600" height="200" />
 <p></p> </p>
<h2>Show in Video</h2>
<div class="highlight"><pre><span></span><span class="c1">### Import everything needed to edit/save/watch video clips</span>
<span class="kn">from</span> <span class="nn">moviepy.editor</span> <span class="kn">import</span> <span class="n">VideoFileClip</span>
<span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">HTML</span>
<span class="c1"># Set up lines for left and right</span>
<span class="n">left_lane</span> <span class="o">=</span> <span class="n">Line</span><span class="p">()</span>
<span class="n">right_lane</span> <span class="o">=</span> <span class="n">Line</span><span class="p">()</span>
<span class="n">white_output</span> <span class="o">=</span> <span class="s1">&#39;output.mp4&#39;</span>
<span class="n">clip1</span> <span class="o">=</span> <span class="n">VideoFileClip</span><span class="p">(</span><span class="s2">&quot;project_video.mp4&quot;</span><span class="p">)</span>
<span class="n">white_clip</span> <span class="o">=</span> <span class="n">clip1</span><span class="o">.</span><span class="n">fl_image</span><span class="p">(</span><span class="n">process_image</span><span class="p">)</span> <span class="c1">#NOTE: this function expects color images!!</span>
<span class="o">%</span><span class="n">time</span> <span class="n">white_clip</span><span class="o">.</span><span class="n">write_videofile</span><span class="p">(</span><span class="n">white_output</span><span class="p">,</span> <span class="n">audio</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</pre></div>


<div class="highlight"><pre><span></span>[MoviePy] &gt;&gt;&gt;&gt; Building video output.mp4
[MoviePy] Writing video output.mp4


100%|█████████▉| 1260/1261 [06:33&lt;00:00,  3.18it/s]


[MoviePy] Done.
[MoviePy] &gt;&gt;&gt;&gt; Video ready: output.mp4

CPU times: user 6min 41s, sys: 1min 15s, total: 7min 56s
Wall time: 6min 34s
</pre></div>
    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
                <div class="social">
                        <h2>social</h2>
                        <ul>
                            <li><a href="/feeds/all.atom.xml" type="application/atom+xml" rel="alternate">atom feed</a></li>

                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

</body>
</html>